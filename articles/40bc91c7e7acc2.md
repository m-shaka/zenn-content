---
title: "Cloudflare Workersã®ãƒ†ã‚¹ãƒˆã®æ›¸ãæ–¹"
emoji: "ğŸ§ª"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["cloudflareworkers", "test", "hono"]
published: true
---

## ã¯ã˜ã‚ã«
æœ¬ç¨¿ã¯ã€ç­†è€…ãŒå®Ÿéš›ã«æ¥­å‹™ã§æ¡ç”¨ã—ã¦ã„ã‚‹Cloudflare Workersã®ãƒ†ã‚¹ãƒˆã®æ›¸ãæ–¹ã‚’ç´¹ä»‹ã™ã‚‹ã‚‚ã®ã§ã™ã€‚ç¬¬ä¸€ã«æƒ³å®šã™ã‚‹èª­è€…ã¯ã€ã€ŒCloudflare Workersã®åˆ©ç”¨ã‚’æ¤œè¨ã—ã¦ã„ã‚‹ãŒã€ãƒ†ã‚¹ãƒˆã«ã¤ã„ã¦ã¯ã¾ã èª¿æŸ»ãŒé€²ã‚“ã§ã„ãªã„çŠ¶æ…‹ã®æ–¹ã€ã¨ãªã‚Šã¾ã™ã€‚åŒæ™‚ã«ã€ç­†è€…ã¨ã—ã¦ã‚‚ã¾ã æ‰‹æ¢ã‚ŠçŠ¶æ…‹ã§ã¯ã‚ã‚‹ã®ã§ã€ã™ã§ã«ãƒ†ã‚¹ãƒˆã‚’æ›¸ã„ã¦é‹ç”¨ã—ã¦ã„ã‚‹æ–¹ã‹ã‚‰ã®æ„Ÿæƒ³ãƒ»ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚‚æ­“è¿ã—ã¦ã„ã¾ã™ã€‚
ã¾ãŸã€çµ‚ç›¤ã«Hono RPCã«ã¤ã„ã¦è§¦ã‚Œã‚‹ã®ã§ã€ã‚‚ã—ä¸æ¡ˆå†…ãªæ–¹ãŒã„ã‚‰ã£ã—ã‚ƒã‚Œã°[ä½œè€…ã®æ–¹ã«ã‚ˆã‚‹ç´¹ä»‹è¨˜äº‹](https://zenn.dev/yusukebe/articles/a00721f8b3b92e)ã‚’å…ˆã«ã”è¦§ã„ãŸã ãã¨ã‚ˆã„ã¨æ€ã„ã¾ã™ã€‚[^1]

[^1]: ç­†è€…ã®æœ€è¿‘ã®è¨˜äº‹ã‚’èª­ã¾ã‚Œã¦ã„ã‚‹ã¨ã„ã†é«˜å¾³ãªæ–¹ã¯ã€Œã¾ãŸã‹ã€ã¨æ€ã‚ã‚Œã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€Hono RPCã¯æœ¬å½“ã«é–‹ç™ºè€…ä½“é¨“ã‚’çˆ†ä¸Šã’ã—ã¦ãã‚Œã‚‹ã®ã§è‡³ã‚‹ã¨ã“ã‚ã§æ“¦ã£ã¦ã„ãã¾ã™ã€‚

## ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ
ã“ã“ã§å³å¯†ãªå®šç¾©å•é¡Œã«é–¢ã‚ã‚‹ã®ã¯æœ¬æ„ã§ã¯ãªã„ãŸã‚ã€ã•ã—ã‚ãŸã‚Šã€ŒDBã‚¢ã‚¯ã‚»ã‚¹ã‚„inbound/outboundã®HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã€ãªã©ãŒãƒ¢ãƒƒã‚¯ã•ã‚ŒãŸãƒ†ã‚¹ãƒˆã ã¨è€ƒãˆã¦ã‚‚ã‚‰ãˆã‚‹ã¨å¹¸ã„ã§ã™ã€‚

ã“ã®ã‚±ãƒ¼ã‚¹ã§ã¯ã€CloudflareãŒå…¬å¼ã§æä¾›ã—ã¦ã„ã‚‹[@cloudflare/vitest-pool-workers](https://developers.cloudflare.com/workers/testing/vitest-integration/)ã‚’ãã®ã¾ã¾ä½¿ãˆã°ã‚ˆã„ã§ã™ã€‚Vitestã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œç’°å¢ƒã‚’workerd[^2]ã«ç½®ãæ›ãˆã‚‹ã‚‚ã®ã§ã€ã“ã‚Œã«ã‚ˆã£ã¦æœ¬ç•ªã«è¿‘ã„ç’°å¢ƒã§ã®ãƒ†ã‚¹ãƒˆãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

[^2]: ã‚ãã¾ã§ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç’°å¢ƒã§ã¯ã‚ã‚Šã¾ã™ãŒã€ã“ã®å…ˆã‚‚ç‰¹ã«æ–­ã‚Šã‚‚å…¥ã‚Œãšã«workerdã¨å‘¼ã¶ã“ã¨ã«ã—ã¾ã™ã€‚

ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰è‡ªä½“ã®å¤‰æ›´ã¯å…¨ãå¿…è¦ãªãã€`vitest.config.ts`ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«å¤‰æ›´ã™ã‚‹ã ã‘ã§ã™ã€‚

```typescript
import { defineWorkersConfig } from "@cloudflare/vitest-pool-workers/config";

export default defineWorkersConfig({
  test: {
    poolOptions: {
      workers: {
        wrangler: {
          configPath: "./wrangler.toml"
        },
      },
    },
  },
});
```

:::details åŸ·ç­†æ™‚ç‚¹ã§ã®åˆ¶ç´„
2024/07/21æ™‚ç‚¹ã«ãŠã„ã¦ã€`@cloudflare/vitest-pool-workers`ã¯vitest > 1.6.0ã§ã¯å‹•ä½œã—ã¾ã›ã‚“ã€‚vitest-pool-workersã¯vitestã®ä¸€éƒ¨ã‚‚workerdã§å‹•ã‹ã—ã¦ã„ã‚‹ã®ã§ã™ãŒã€vitest@1.6ã‹ã‚‰workerdãŒå®Ÿè£…ã—ã¦ã„ãªã„`node:fs`ã«ä¾å­˜ã™ã‚‹ã‚³ãƒ¼ãƒ‰ãŒãã“ã«è¿½åŠ ã•ã‚ŒãŸãŸã‚å‹•ã‹ãªããªã£ã¦ã—ã¾ã„ã¾ã—ãŸã€‚[vitest@2ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹PR](https://github.com/cloudflare/workers-sdk/pull/6232)ãŒãƒ‰ãƒ©ãƒ•ãƒˆã§ç«‹ã£ã¦ã„ã‚‹ã®ã§ã€ã“ã‚ŒãŒãƒãƒ¼ã‚¸ã•ã‚Œã‚Œã°å‹•ãã¨æ€ã‚ã‚Œã¾ã™ã€‚
:::

## ã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ
ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã¨åŒæ§˜ã«ã“ã®å ´ã ã‘ã®å®šç¾©ã‚’å°å…¥ã™ã‚‹ã¨ã€ã€Œä½•ã‚‚ãƒ¢ãƒƒã‚¯ã›ãšã«HTTPã‚’ã—ã‚ƒã¹ã‚‹ãƒ†ã‚¹ãƒˆã€ã‚’æŒ‡ã™ã“ã¨ã«ã—ã¾ã™ã€‚ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒ`/foo`ã¨ã„ã†ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’æä¾›ã—ã¦ãŸã‚‰ã€å®Ÿéš›ã«`/foo`ã«HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚Šã€ãã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’æ¤œè¨¼ã™ã‚‹ãƒ†ã‚¹ãƒˆã§ã™ã€‚

`@cloudflare/vitest-pool-workers`ã¯ã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆã‚‚ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ãŒã€ç­†è€…ã¯åˆ¥ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’å–ã£ã¦ã„ã¾ã™ã€‚ã¾ãšvitest-pool-workersã§ã®æ›¸ãæ–¹ã‚’ç°¡å˜ã«èª¬æ˜ã—ãŸã®ã¡ã€ç­†è€…ãŒæ¡ç”¨ã—ã¦ã„ã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

### vitest-pool-workersã§ã®æ›¸ãæ–¹ã¨å•é¡Œç‚¹
vitest-pool-workersã§ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€`cloudflare:test`ã¨ã„ã†ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚ã“ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒexportã—ã¦ã„ã‚‹`SELF`ã¨ã„ã†ãƒ¡ãƒ³ãƒãƒ¼ã¯ã€`wrangler.toml`ã§æŒ‡å®šã•ã‚ŒãŸentrypointã‚’bindã—ã¦ã„ã¾ã™ã€‚ã™ã‚‹ã¨ã€ã“ã®ã‚ˆã†ã«HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```typescript
import { SELF } from "cloudflare:test";

it("dispatches fetch event", async () => {
  const response = await SELF.fetch("https://example.com");
  expect(await response.text()).toMatchInlineSnapshot(...);
});
```
`SELF`ã‚’ä½¿ã£ãŸãƒ†ã‚¹ãƒˆã¯éå¸¸ã«ã‚·ãƒ³ãƒ—ãƒ«ã§ã¯ã‚ã‚‹ã®ã§ã™ãŒã€DBãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®æ‰±ã„ãŒãƒãƒƒã‚¯ã«ãªã‚Šã¾ã—ãŸã€‚ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œå‰ã«DBã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ°ã‚‰ã›ãŸã„ã®ã§ã™ãŒã€ãã®å®Ÿç¾æ–¹æ³•ã¨ã—ã¦æµ®ã‹ã‚“ã ã®ã¯æ¬¡ã®2ã¤ã§ã—ãŸã€‚
1. vitestã®èµ·å‹•å‰ã«Dockerã‚³ãƒãƒ³ãƒ‰ã§DBã‚’ç«‹ã¡ä¸Šã’ã¦ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
1. vitestã®èµ·å‹•å¾Œã«testcontainersã§DBã‚’ç«‹ã¡ä¸Šã’ã¦ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

1ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã¯ä»¥å‰ã«ã‚‚ã‚„ã£ãŸã“ã¨ãŒã‚ã‚‹ã®ã§ã™ãŒã€ã‚·ã‚§ãƒ«ã‚’ã”ã«ã‚‡ã”ã«ã‚‡ã—ãªã‘ã‚Œã°ãªã‚‰ãšã‚ã¾ã‚Šå¥½ã¿ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ä¸€æ–¹ã€2ã®å ´åˆã¯ã‚·ãƒ³ã‚°ãƒ«ã‚³ãƒãƒ³ãƒ‰ã§æ¸ˆã‚€ä¸Šã«ã€ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã®ç›¸æ€§ã‚‚ã‚ˆã•ãã†ã§ã—ãŸã€‚ã¨ã„ã†ã®ã‚‚ã€ORMã«drizzleã‚’ä½¿ã£ã¦ãŠã‚Šã€drizzleã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¯ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°APIã‚‚æä¾›ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€testcontainersã§DBã‚’èµ·å‹•ã—ãŸã‚ã¨ã«ã¡ã‚‡ã‚ã£ã¨ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã‘ã°ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒå¯èƒ½ã§ã‚ã‚‹ã“ã¨ãŒæœŸå¾…ã§ããŸã‹ã‚‰ã§ã™ã€‚ã“ã†ã—ãŸç†ç”±ã‹ã‚‰2ã®æ–¹ã§é€²ã‚€ã“ã¨ã«ã—ã¾ã—ãŸã€‚

### testcontainersã¨ã®ç¹‹ãè¾¼ã¿
ãƒ†ã‚¹ãƒˆå…¨ä½“ã®setupæ™‚ã«DBãŒç«‹ã¡ä¸ŠãŒã‚Šã€çµ‚äº†æ™‚ã«è½ã¡ã‚‹ã¨å¬‰ã—ã„ã§ã™ã€‚ãã®ãŸã‚ã«ã¯Vitestã®[environment](https://vitest.dev/guide/environment.html)ã‚’ä½¿ã†ã¨ã‚ˆã•ãã†ã§ã€å®Ÿéš›ã«ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£è£½ã®[vitest-environment-testcontainers](https://github.com/dextertanyj/vitest-environment-testcontainers)ã‚‚å­˜åœ¨ã—ã¾ã—ãŸã€‚ã¨ã“ã‚ãŒã€vitest-pool-workersã¯environmentã®å¤‰æ›´ã‚’è¨±å¯ã—ã¦ã„ãªã„ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚

ã¨ãªã‚‹ã¨ã€vitest-pool-workersã«å›ºåŸ·ã™ã‚‹ãªã‚‰ã°1ã¨ã„ã†ã“ã¨ã«ãªã‚Šã¾ã™ãŒã€å‰è¿°ã®2ã®ãƒ¡ãƒªãƒƒãƒˆã‚’äº«å—ã—ãŸã„ã®ã§ã€2ã§ãªã‚“ã¨ã‹ã™ã‚‹æ–¹æ³•ã‚’æ¨¡ç´¢ã™ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚

### unstable_dev APIã‚’ä½¿ã†
workerd runtimeã‚’ä½¿ã†æ–¹æ³•ã¯vitest-pool-workersã ã‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚Cloudflare Workersã¯Node.jså‘ã‘ã«[unstable_dev API](https://developers.cloudflare.com/workers/wrangler/api/#unstable_dev)ã‚‚æä¾›ã—ã¦ãŠã‚Šã€ã“ã‚Œã‚’ä½¿ã†ã“ã¨ã§workerdã®ä¸Šã§HTTPã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

DBèµ·å‹•ã¨åŒæ§˜ã«ã€ã‚µãƒ¼ãƒãƒ¼ã‚‚ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå‰ã«ä¸€åº¦ã ã‘ç«‹ã¡ä¸ŠãŒã£ã¦æ¬²ã—ã„ã®ã§ã€environmentã‚’ä½¿ã†ã“ã¨ã«ã—ã¾ã—ãŸã€‚testcontainersã®environmentã‚‚ä½¿ã„ãŸã„ã®ã§ã€è‡ªåˆ†ã§ã‚«ã‚¹ã‚¿ãƒ environmentã‚’å®šç¾©ã—ã¾ã—ãŸã€‚ä»¥ä¸‹ã¯ãã®æŠœç²‹ã§ã™ã€‚

```typescript
import dotenv from 'dotenv'
import { drizzle } from 'drizzle-orm/postgres-js'
import { migrate } from 'drizzle-orm/postgres-js/migrator'
import { hc } from 'hono/client'
import postgres from 'postgres'
import { type Environment, type EnvironmentReturn } from 'vitest'
import { type EnvironmentOptions, default as testContainersEnv } from 'vitest-environment-testcontainers'
import { unstable_dev } from 'wrangler'
import type { AppType } from '~/type.js'

const POSTGRES_USER = 'postgres',
  POSTGRES_PASSWORD = 'postgres',
  POSTGRES_DB = 'postgres',
  POSTGRES_PORT = 5432

const environmentOptions: EnvironmentOptions = {
  testcontainers: {
    containers: [
      {
        name: 'database',
        image: 'postgres:latest',
        ports: [{ container: 5432, host: POSTGRES_PORT }],
        environment: {
          POSTGRES_USER,
          POSTGRES_PASSWORD,
          POSTGRES_DB
        },
        wait: {
          type: 'PORT'
        }
      }
    ]
  }
}

const connectionString = `postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@127.0.0.1:${POSTGRES_PORT}/${POSTGRES_DB}`

const setupApiClient = async (): Promise<EnvironmentReturn> => {
  process.env['WRANGLER_HYPERDRIVE_LOCAL_CONNECTION_STRING_HYPERDRIVE'] = connectionString
  const worker = await unstable_dev('./src/index.ts', {
    logLevel: 'info',
    experimental: { disableExperimentalWarning: true }
  })
  globalThis.testApiClient = hc<AppType>('', { fetch: worker.fetch.bind(worker) })
  return {
    teardown: async () => {
      await worker.stop()
    }
  }
}

const setupMigration = async (): Promise<EnvironmentReturn> => {
  const client = postgres(connectionString)
  await migrate(drizzle(client), { migrationsFolder: '<your-migration-folder>' })
  return { teardown: async () => {} }
}

export default (<Environment>{
  ...testContainersEnv,
  name: 'custom-environment',
  async setup(global_) {
    dotenv.config({ path: '.dev.vars' })
    const teardownFuncs = [
      await testContainersEnv.setup(global_, environmentOptions),
      await setupMigration(),
      await setupApiClient()
    ]

    return {
      teardown: async global_ => {
        for (const { teardown } of teardownFuncs.toReversed()) {
          await teardown(global_)
        }
      }
    }
  }
})

declare global {
  const testApiClient: ReturnType<typeof hc<AppType>>
}
```

å‡¦ç†ã®æµã‚Œã¨ã—ã¦ã¯ã€æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

1. testcontainersã®environmentã§Postgresã‚’èµ·å‹•
1. drizzleã§ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆ`setupMigration`é–¢æ•°ï¼‰
1. unstable_devã§ã‚µãƒ¼ãƒãƒ¼èµ·å‹•ï¼ˆ`setupApiClient`é–¢æ•°ï¼‰

ãŸã ã—ã€`setupApiClient`ã¯ãã®åã®é€šã‚Šã€ã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•ä»¥ä¸Šã®ä»•äº‹ã‚’ã“ãªã—ã¦ã„ã¾ã™ã€‚`unstable_dev`ã¯ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã™ã‚‹ã¨ã¨ã‚‚ã«ã€æˆ»ã‚Šå€¤ã¨ã—ã¦`fetch API`ã‚’å®Ÿè£…ã—ãŸ`fetch`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æŒã£ãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿”ã—ã¾ã™ã€‚ãã®ãŸã‚ã€Hono RPCã¨çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ãŒã§ãã€ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‹ã‚‰ã¯å‹ã®ã‚µãƒãƒ¼ãƒˆã‚’å—ã‘ã¤ã¤HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹ã“ã¨ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚ã“ã‚“ãªå…·åˆã§ã™ã€‚

```typescript
describe('POST /foo', () => {
  it('returns 200', async () => {
    const response = await testApiClient.foo.$post({
        json: {
            foo: 1 // typed!
        }
    })
    expect(response.status).toBe(200)
  })
})
```
